name: Deploy to Server

on:
  push:
    branches:
      - master
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  PROJECT_NAME: "æµ·å…‹æ–¯å¤§ä¹±æ–—"
  SERVER_PORT: 22
  WORK_DIR: /root/docker/lol-hex-lite/lol-hex

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¢ Deploy Start Notification
        run: |
          curl -X POST "${{ secrets.DINGTALK_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "msgtype": "markdown",
              "markdown": {
                "title": "ğŸš€ å¼€å§‹éƒ¨ç½²",
                "text": "### ğŸš€ ${{ env.PROJECT_NAME }} - å¼€å§‹éƒ¨ç½²\n\n> **ç¯å¢ƒ**: ç”Ÿäº§ç¯å¢ƒ\n> **åˆ†æ”¯**: ${{ github.ref_name }}\n> **æäº¤äºº**: ${{ github.actor }}\n> **æäº¤ä¿¡æ¯**: ${{ github.event.head_commit.message }}\n> **æ—¶é—´éƒ¨ç½²å¼€å§‹"
              }
            }'

      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸš€ Deploy to Server
        run: |
          echo ">>> å¼€å§‹éƒ¨ç½²åˆ°æœåŠ¡å™¨..."

          # SSH è¿æ¥æœåŠ¡å™¨æ‰§è¡Œéƒ¨ç½²
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            cd /root/docker/lol-hex-lite/lol-hex

            # å‘é€å¼€å§‹é€šçŸ¥
            TIMESTAMP=$(date +%s)000
            SIGN=$(printf '%s\n%s' "$TIMESTAMP" "${{ secrets.DINGTALK_SECRET }}" | openssl dgst -sha256 -hmac "${{ secrets.DINGTALK_SECRET }}" -binary | openssl base64 | tr -d '\n')
            SIGN_ENCODED=$(echo -n "$SIGN" | jq -sRr @uri)
            curl -X POST "${{ secrets.DINGTALK_WEBHOOK }}&timestamp=${TIMESTAMP}&sign=${SIGN_ENCODED}" \
              -H "Content-Type: application/json" \
              -d '{"msgtype":"text","text":{"content":"ğŸš€ å¼€å§‹éƒ¨ç½²..."}}'

            # æ‹‰å–æœ€æ–°ä»£ç 
            git pull origin master

            # æ„å»ºå¹¶é‡å¯å®¹å™¨
            docker stop lol-hex 2>/dev/null || true
            docker rm lol-hex 2>/dev/null || true
            docker build -t lol-hex:latest .
            docker run -d \
              --name lol-hex \
              --env-file /root/docker/lol-hex-lite/lol-hex/server/.env \
              -p 28080:80 \
              -p 28899:8899 \
              --restart unless-stopped \
              lol-hex:latest

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 10

            # å¥åº·æ£€æŸ¥
            if curl -f -s http://localhost:28899/health > /dev/null; then
              echo "âœ“ éƒ¨ç½²æˆåŠŸ"

              # å‘é€æˆåŠŸé€šçŸ¥
              TIMESTAMP=$(date +%s)000
              SIGN=$(printf '%s\n%s' "$TIMESTAMP" "${{ secrets.DINGTALK_SECRET }}" | openssl dgst -sha256 -hmac "${{ secrets.DINGTALK_SECRET }}" -binary | openssl base64 | tr -d '\n')
              SIGN_ENCODED=$(echo -n "$SIGN" | jq -sRr @uri)
              curl -X POST "${{ secrets.DINGTALK_WEBHOOK }}&timestamp=${TIMESTAMP}&sign=${SIGN_ENCODED}" \
                -H "Content-Type: application/json" \
                -d '{
                  "msgtype": "markdown",
                  "markdown": {
                    "title": "âœ… éƒ¨ç½²æˆåŠŸ",
                    "text": "### âœ… ${{ env.PROJECT_NAME }} - éƒ¨ç½²æˆåŠŸ\n\n> **ç¯å¢ƒ**: ç”Ÿäº§ç¯å¢ƒ\n> **æäº¤äºº**: ${{ github.actor }}\n> **è®¿é—®åœ°å€**: http://101.42.154.80:28080"
                  }
                }'
            else
              echo "âœ— éƒ¨ç½²å¤±è´¥"

              # å‘é€å¤±è´¥é€šçŸ¥
              TIMESTAMP=$(date +%s)000
              SIGN=$(printf '%s\n%s' "$TIMESTAMP" "${{ secrets.DINGTALK_SECRET }}" | openssl dgst -sha256 -hmac "${{ secrets.DINGTALK_SECRET }}" -binary | openssl base64 | tr -d '\n')
              SIGN_ENCODED=$(echo -n "$SIGN" | jq -sRr @uri)
              curl -X POST "${{ secrets.DINGTALK_WEBHOOK }}&timestamp=${TIMESTAMP}&sign=${SIGN_ENCODED}" \
                -H "Content-Type: application/json" \
                -d '{
                  "msgtype": "markdown",
                  "markdown": {
                    "title": "âŒ éƒ¨ç½²å¤±è´¥",
                    "text": "### âŒ ${{ env.PROJECT_NAME }} - éƒ¨ç½²å¤±è´¥\n\n> **é”™è¯¯**: å¥åº·æ£€æŸ¥å¤±è´¥\n\n@è¯·æ£€æŸ¥ï¼"
                  }
                }'
              exit 1
            fi
          ENDSSH

      - name: âœ… Deploy Success Notification
        if: success()
        run: |
          curl -X POST "${{ secrets.DINGTALK_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "msgtype": "markdown",
              "markdown": {
                "title": "âœ… éƒ¨ç½²æˆåŠŸ",
                "text": "### âœ… GitHub Actions éƒ¨ç½²å®Œæˆ\n\n> **é¡¹ç›®**: ${{ env.PROJECT_NAME }}\n> **æäº¤äºº**: ${{ github.actor }}\n> **è®¿é—®åœ°å€**: http://101.42.154.80:28080"
              }
            }'

      - name: âŒ Deploy Failure Notification
        if: failure()
        run: |
          curl -X POST "${{ secrets.DINGTALK_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "msgtype": "markdown",
              "markdown": {
                "title": "âŒ éƒ¨ç½²å¤±è´¥",
                "text": "### âŒ GitHub Actions éƒ¨ç½²å¤±è´¥\n\n> **é¡¹ç›®**: ${{ env.PROJECT_NAME }}\n> **æäº¤äºº**: ${{ github.actor }}\n> **é”™è¯¯**: è¯·æŸ¥çœ‹ GitHub Actions æ—¥å¿—\n\n@è¯·æ£€æŸ¥ï¼"
              }
            }'
